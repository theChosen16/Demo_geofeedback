version: '3.8'

services:
  # PostgreSQL with PostGIS
  postgis:
    image: postgis/postgis:16-3.4
    container_name: geofeedback_postgis
    environment:
      POSTGRES_DB: geofeedback_papudo
      POSTGRES_USER: geofeedback
      POSTGRES_PASSWORD: Papudo2025
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "5433:5432"  # Mapped to 5433 to avoid conflict with local PostgreSQL
    volumes:
      - postgis_data:/var/lib/postgresql/data
      - ./init:/docker-entrypoint-initdb.d
    networks:
      - geonetwork
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U geofeedback"]
      interval: 10s
      timeout: 5s
      retries: 5

  # GeoServer
  geoserver:
    image: kartoza/geoserver:2.24.0
    container_name: geofeedback_geoserver
    environment:
      # GeoServer admin credentials
      GEOSERVER_ADMIN_USER: admin
      GEOSERVER_ADMIN_PASSWORD: GeoFeedback2025

      # Java options
      GEOSERVER_JAVA_OPTS: >-
        -Xms512m
        -Xmx2g
        -XX:+UseParallelGC
        -XX:ParallelGCThreads=4
        -Djava.awt.headless=true
        -XX:+UseStringDeduplication

      # Enable CORS
      ENABLE_CORS: "true"

      # Timezone
      TZ: America/Santiago

    ports:
      - "8080:8080"
    volumes:
      - geoserver_data:/opt/geoserver/data_dir
      - ./styles:/opt/styles
      - ./data:/opt/geoserver_data
    depends_on:
      postgis:
        condition: service_healthy
    networks:
      - geonetwork
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/geoserver/web/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped

volumes:
  postgis_data:
    driver: local
  geoserver_data:
    driver: local

networks:
  geonetwork:
    driver: bridge
